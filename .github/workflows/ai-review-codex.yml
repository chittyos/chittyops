name: AI Review - OpenAI Codex

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  codex-review:
    name: OpenAI Codex Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || 
                            context.payload.inputs?.pr_number;
            
            if (!prNumber) {
              throw new Error('No PR number found');
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            core.setOutput('number', prNumber);
            core.setOutput('title', pr.title);
            core.setOutput('base', pr.base.ref);
            core.setOutput('head', pr.head.ref);
            return pr;

      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          git fetch origin pull/${PR_NUMBER}/head:pr-${PR_NUMBER}
          git diff origin/${{ steps.pr.outputs.base }}...pr-${PR_NUMBER} > pr-diff.txt
          
          # Limit diff size to avoid API limits
          head -c 40000 pr-diff.txt > pr-diff-limited.txt
          
          echo "Diff size: $(wc -c < pr-diff-limited.txt) bytes"

      - name: Get changed files
        id: files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const fileList = files.map(f => `${f.filename} (+${f.additions}/-${f.deletions})`).join('\n');
            const extensions = [...new Set(files.map(f => f.filename.split('.').pop()))];
            
            core.setOutput('list', fileList);
            core.setOutput('count', files.length);
            core.setOutput('extensions', extensions.join(','));
            return fileList;

      - name: Analyze with OpenAI
        id: openai
        if: env.OPENAI_API_KEY != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PR_TITLE="${{ steps.pr.outputs.title }}"
          PR_DIFF=$(cat pr-diff-limited.txt)
          FILES="${{ steps.files.outputs.list }}"
          
          # Create OpenAI API request
          cat > openai-request.json << 'EOFX'
          {
            "model": "gpt-4-turbo-preview",
            "messages": [
              {
                "role": "system",
                "content": "You are an expert security and code quality analyst. Your role is to identify security vulnerabilities, code quality issues, and performance problems in code changes."
              },
              {
                "role": "user",
                "content": "Analyze this pull request for:\n\n1. **Security Vulnerabilities**: SQL injection, XSS, authentication bypasses, insecure dependencies, exposed secrets\n2. **Code Quality**: Code smells, anti-patterns, maintainability issues\n3. **Performance**: Inefficient algorithms, memory leaks, N+1 queries, blocking operations\n4. **Best Practices**: Language-specific conventions, error handling, logging\n\nPull Request Title: PR_TITLE_PLACEHOLDER\n\nChanged Files:\nFILES_PLACEHOLDER\n\nCode Diff:\nDIFF_PLACEHOLDER\n\nProvide findings in markdown format with severity ratings (üî¥ Critical, üü° Medium, üü¢ Low)."
              }
            ],
            "max_tokens": 4096,
            "temperature": 0.3
          }
          EOFX
          
          # Escape and insert values (basic escaping for JSON)
          ESCAPED_DIFF=$(echo "$PR_DIFF" | jq -Rs .)
          ESCAPED_FILES=$(echo "$FILES" | jq -Rs .)
          ESCAPED_TITLE=$(echo "$PR_TITLE" | jq -Rs .)
          
          # Replace placeholders
          jq --arg diff "$ESCAPED_DIFF" \
             --arg files "$ESCAPED_FILES" \
             --arg title "$ESCAPED_TITLE" \
             '.messages[1].content = (.messages[1].content | 
               gsub("PR_TITLE_PLACEHOLDER"; $title) | 
               gsub("FILES_PLACEHOLDER"; $files) | 
               gsub("DIFF_PLACEHOLDER"; $diff))' \
             openai-request.json > openai-request-final.json
          
          # Call OpenAI API
          RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @openai-request-final.json)
          
          # Extract review content
          echo "$RESPONSE" | jq -r '.choices[0].message.content' > openai-review.md
          
          # Check if review was generated
          if [ -s openai-review.md ] && ! grep -q "null" openai-review.md; then
            echo "review_generated=true" >> $GITHUB_OUTPUT
            echo "OpenAI review generated successfully"
          else
            echo "review_generated=false" >> $GITHUB_OUTPUT
            echo "Failed to generate OpenAI review"
            echo "API Response: $RESPONSE"
          fi

      - name: Post OpenAI review
        if: steps.openai.outputs.review_generated == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('openai-review.md', 'utf8');
            
            const prNumber = ${{ steps.pr.outputs.number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## üîç OpenAI Security & Quality Analysis\n\n${review}\n\n---\n*Powered by GPT-4 Turbo*`
            });

      - name: Create check run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const reviewGenerated = '${{ steps.openai.outputs.review_generated }}' === 'true';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'ai-review-codex',
              head_sha: pr.head.sha,
              status: 'completed',
              conclusion: reviewGenerated ? 'success' : 'neutral',
              output: {
                title: reviewGenerated ? 'OpenAI analysis completed' : 'OpenAI analysis skipped',
                summary: reviewGenerated ? 
                  'Security and quality analysis completed. Check PR comments for findings.' :
                  'OpenAI API key not configured. Analysis skipped.'
              }
            });

      - name: Handle missing API key
        if: env.OPENAI_API_KEY == ''
        run: |
          echo "::warning::OPENAI_API_KEY not configured. Codex review skipped."
          echo "To enable OpenAI reviews, add OPENAI_API_KEY to repository secrets."
