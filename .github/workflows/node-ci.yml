name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Syntax check JS files
        run: |
          node -c compliance/audit.js
          node -c compliance/remediate.js
          node -c compliance/lib/github-checker.js
          node -c compliance/lib/runtime-checker.js
          node -c compliance/lib/report-generator.js

      - name: Syntax check bash scripts
        run: |
          bash -n setup-org-workflows.sh
          bash -n scripts/onboard-service.sh

      - name: Validate YAML files
        run: |
          node -e "
            const yaml = require('js-yaml');
            const fs = require('fs');
            const files = ['compliance/service-registry.yml', 'compliance/checks.yml'];
            for (const f of files) {
              try {
                yaml.load(fs.readFileSync(f, 'utf8'));
                console.log('OK: ' + f);
              } catch (e) {
                console.error('FAIL: ' + f + ' - ' + e.message);
                process.exit(1);
              }
            }
          "

      - name: Run tests
        run: pnpm test

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Run ShellCheck
        run: |
          shellcheck setup-org-workflows.sh || true
          shellcheck scripts/onboard-service.sh || true
